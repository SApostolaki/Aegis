{% extends 'v1.0_seismic_hazard.html' %}
{% block title %} Uniform Hazard Spectra (UHS) - {{ super() }}{% endblock %}

{% block content %}
<!-- Banner content -->
<div
  id="banner"
  style="
    height: 10vh;
    width: 100%;
    background-color: #cf6f4f;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  "
>
  <h1 style="color: #fff; text-align: center; margin: 0">
    Uniform Hazard Spectra (UHS)
  </h1>


  <!-- Logo -->
  <img
    src="../images/Aegis_logo.png"
    alt="Logo"
    style="
      height: 9vh;
      position: absolute;
      right: 5vh;
      z-index: 2;
    "
  />
</div>

<!-- Main content -->
<div
  id="content"
  style="
    display: flex;
    height: 75vh;
    justify-content: space-evenly;
    align-items: flex-start;
    background-color: #fefdfc;
    flex-wrap: wrap;
    margin-top: 8vh;
    z-index: 1;
  "
>
  <!-- Left-side area-->
  <div
    id="left-content"
    style="flex: 0.5; padding: 3vh; height: 100%; display: flex; flex-direction: column; background-color: #e6b178; color: #241f25; font-size: clamp(1.5vh, 1vw, 2rem);">
    <p>
        Uniform Hazard Spectrum (UHS) is defined as a set of spectral acceleration values over a range of vibration periods with equal probability of exceedance in a period of time.
        These UHS values correspond to spectral accelerations at the soil surface, considering local site conditions.
      </p>
      <em style="font-size: 0.85em; color: #444;">
        üìç Click on any point on the map to view its UHS.
      </em>
      
    <!-- Parameter Section -->
    <div
      id="parameters"
      style="width: 100%; flex: 0 1 auto;">
      <h3>Coordinates</h3>

      <!-- Longitude Input -->
      <label for="longitude">Longitude:</label>
      <input
        type="float"
        id="longitude"
        name="longitude"
        placeholder="Enter"
        style="
          width: 25%;
          background-color: #fefdfc;
          border: 2px solid #cf6f4f;
          color: #241f25;
          margin-bottom: 8px;
        "
      />

      <!-- Latitude Input -->
      <label for="latitude">Latitude:</label>
      <input
        type="float"
        id="latitude"
        name="latitude"
        placeholder="Enter"
        style="
          width: 25%;
          background-color: #fefdfc;
          border: 2px solid #cf6f4f;
          color: #241f25;
          margin-bottom: 8px;
        "
      /><br />

      <h3>Parameters</h3>

      <!-- Site Model 
      <label for="site-model">Site Model:</label>
      <select
        id="site-model"
        name="site-model"
        style="
          width: auto;
          background-color: #fefdfc;
          border: 2px solid #cf6f4f;
          color: #241f25;
          margin-bottom: 1%;
        "
      >
        <option value="reference-rock">Reference Rock</option>
        <option value="esrm20" selected>ESRM20 Site Model</option>
      </select><br /> -->

      <!-- Percentile -->
      <label for="percentile">Statistical measure:</label>
      <select
        id="percentile"
        name="percentile"
        style="
          width: auto;
          background-color: #fefdfc;
          border: 2px solid #cf6f4f;
          color: #241f25;
          margin-bottom: 8px;
        "
      >
        <option value="mean"selected>Mean</option>
        <option value="0.05">0.05</option>
        <option value="0.16">0.16</option>
        <option value="0.50">0.50 (Median)</option>
        <option value="0.84">0.84</option>
        <option value="0.95">0.95</option></select
      ><br />

      <style>
        /* Style for checkboxes */
        input[type="checkbox"] {
            display: none; /* Hide the default checkbox */
        }
    
        /* Style for custom checkboxes */
        input[type="checkbox"] + label {
            position: relative;
            padding-left: 2em;
            cursor: pointer;
        }
    
        /* Style for checkbox ticks */
        input[type="checkbox"] + label:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 1em;
            height: 1em;
            border: 2px solid #cf6f4f;
            background-color: #fefdfc;
        }
    
        /* Style for checked state - 50y */
        input[type="checkbox"][value="50"]:checked + label:before {
            background-color: rgba(234, 220, 124, 1);}

        /* Style for checked state - 101y */
        input[type="checkbox"][value="101"]:checked + label:before {
            background-color: rgba(255, 177, 51, 1);}
        
        /* Style for checked state - 475y */
        input[type="checkbox"][value="475"]:checked + label:before {
            background-color: rgba(198, 40, 61, 1);}
        
        /* Style for checked state - 975y */
        input[type="checkbox"][value="975"]:checked + label:before {
            background-color: rgb(228, 94, 53);}

        /* Style for checked state - 2500y */
        input[type="checkbox"][value="2500"]:checked + label:before {
            background-color: rgba(77, 181, 136, 1);}

        /* Style for checked state - 5000y */
        input[type="checkbox"][value="5000"]:checked + label:before {
            background-color: rgba(49, 70, 140, 1);}

        /* Style for checked state - 10000y */
        input[type="checkbox"][value="10000"]:checked + label:before {
            background-color: rgba(47, 51, 65, 1);}        
    </style>

      <!-- Return period -->
      <div id="RP" style="margin-top: 2%;">
        <label>Return period (years):</label><br /><br />

        <input type="checkbox" id="rp50" name="RP" value="50">
        <label for="rp50">50</label>

        <input type="checkbox" id="rp101" name="RP" value="101">
        <label for="rp101">101</label>

        <input type="checkbox" id="rp475" name="RP" value="475" checked>
        <label for="rp475">475</label>

        <input type="checkbox" id="rp975" name="RP" value="975">
        <label for="rp975">975</label>

        <input type="checkbox" id="rp2500" name="RP" value="2500">
        <label for="rp2500">2500</label>

        <input type="checkbox" id="rp5000" name="RP" value="5000">
        <label for="rp5000">5000</label>

        <input type="checkbox" id="rp10000" name="RP" value="10000">
        <label for="rp10000">10000</label>
      </div>
      <br>
      
      <!-- Map Section -->
      <div id="map" style="width: 100%; flex-grow: 1; height: auto; min-height: 70%; margin-top: 2%; cursor : 'pointer';"></div>
    </div>
  </div>

    <!-- Right-side area -->
<div id="right-content" style="
flex: 0.5;
padding: 3vh;
height: 100%;
color: #241f25;
background-color: #eed7be;
display: flex;
flex-direction: column;
align-items: center;
position: relative;
overflow: hidden; /* Prevent content overflow */
">

<!-- 2D Graph -->
<div id="graph-container" style="
      flex: 0.95;
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden; 
  ">
  <canvas id="uhs" style="width: 100%; height: 100%;"></canvas>

</div>

  <!-- Download Button (5% Height) -->
  <div id="download" style="
      flex: 0.05;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #cf6f4f;
  ">
      <button id="downloadButton" style="
          padding: 8px 15px;
          background: white;
          color: #cf6f4f;
          border: none;
          border-radius: 5px;
          cursor: pointer;
      ">
          Download Graph
      </button>
  </div>
</div>
</div>

<!-- Include Leaflet, Flask-Leaflet, and Leaflet.Print libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.0.2/chartjs-plugin-annotation.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>

// Initialize the map
  var map = L.map('map').setView([40.6401, 22.9444], 10); // Default: Thessaloniki
  
// Add tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);
  
// Initialize the marker on Thessaloniki
  var marker = L.marker([40.6401, 22.9444]).addTo(map);
  
// Function to update coordinates input boxes
  function updateCoordinates(latlng) {
      document.getElementById('longitude').value = latlng.lng.toFixed(4);
      document.getElementById('latitude').value = latlng.lat.toFixed(4);
  }
  
// Function to set marker to a location
  function setMarker(latlng) {
      marker.setLatLng(latlng);
      updateCoordinates(latlng);
      fetchClosestData(latlng.lng, latlng.lat);
  }
  
// Click event to update marker
  map.on('click', function (e) {
      setMarker(e.latlng);
  });
  
// Add search functionality
var searchControl = L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);
  searchControl.on('markgeocode', function (e) {
      map.panTo(e.geocode.center);
      setMarker(e.geocode.center);
  });

// Define constants for quantiles 
const percentileMapping = {
    "mean": "mean", "0.05": "qq05", "0.16": "qq16", "0.50": "qq50", "0.84": "qq84", "0.95": "qq95"
};


const colorMapping = {
    "50": 'rgba(234, 220, 124, 1)', 
    "101": 'rgba(255, 177, 51, 1)', 
    "475": 'rgba(198, 40, 61, 1)', 
    "975": 'rgb(228, 94, 53)', 
    "2500": 'rgba(77, 181, 136, 1)', 
    "5000": 'rgba(49, 70, 140, 1)', 
    "10000": 'rgba(47, 51, 65, 1)'
};

// Function to get selected return periods
function getSelectedPercentile() {
    var percentileSelect = document.getElementById('percentile');
    return percentileSelect.value;
}

// Function to load and find the closest CSV point to selected coordinates
async function fetchClosestData(lon, lat) {
    const percentile = document.getElementById('percentile').value;
    const selectedRPs = Array.from(document.querySelectorAll('input[name="RP"]:checked')).map(cb => cb.value);
    
    let datasets = [];
    let xLabels = null; // Ensure xLabels is initialized

    for (const rp of selectedRPs) {
        const csvData = await fetchCSV(percentile, rp);
        if (!csvData) continue;

        const result = findClosestPoint(csvData, lon, lat);
        if (result.closestPoint) {
            if (!xLabels) xLabels = result.xLabels; // Assign xLabels only once
            datasets.push({
              label: `RP = ${rp}y`,  // ‚úÖ label must be a string!
              data: result.closestPoint.slice(2).map(Number),
              borderColor: colorMapping[rp],
              borderWidth: 2,
              fill: false
          });
        }
    }

    if (xLabels) {
        updateChart(xLabels, datasets);
    } else {
        clearChart(); // Clear chart if no valid data
    }
}

// Function to fetch CSV file
async function fetchCSV(percentile, rp) {
    
    // Ensure correct filename format
    const filename = `/static/uhs_${percentileMapping[percentile]}_${rp}.csv`;

    try {
        const response = await fetch(filename);
        if (!response.ok) throw new Error(`Failed to load ${filename}. Status: ${response.status}`);
        return await response.text();
    } catch (error) {
        console.error(error);
        return null;
    }
}

// Function to find the closest data point in the CSV file
function findClosestPoint(csvText, targetLon, targetLat) {
    const rows = csvText.trim().split("\n");
    const headers = rows[0].split(",").map(h => h.trim());

    let minDistance = Infinity;
    let closestPoint = null;

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(",").map(c => c.trim());
        const lon = parseFloat(cols[0]);
        const lat = parseFloat(cols[1]);

        if (isNaN(lon) || isNaN(lat)) continue;

        const distance = Math.sqrt(
            Math.pow(lon - targetLon, 2) + Math.pow(lat - targetLat, 2)
        );

        if (distance < minDistance) {
            minDistance = distance;
            closestPoint = [
                lon,
                lat,
                ...cols.slice(2).map(val => parseFloat(val))
            ];
        }
    }

    return {
        closestPoint: closestPoint,
        xLabels: headers.slice(2) // spectral periods (e.g., ["0.01", "0.02", ..., "5.0"])
    };
}

// Chart instance
let chartInstance = null;


// Adjustable fonts
function getResponsiveFontSize(baseSize) {
    return Math.max(window.innerHeight * (baseSize / 100), 10); // Ensures a minimum readable size
}

// Function to update the chart with new data
function updateChart(xLabels, datasets) {
    if (!xLabels || datasets.length === 0) return;

    const ctx = document.getElementById('uhs').getContext('2d');

    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: xLabels.map(Number), // Convert to numbers for proper axis scaling
            datasets: datasets.map(dataset => ({
                ...dataset,
                pointStyle: 'circle',
                pointRadius: 3,
                pointBackgroundColor: dataset.borderColor,
                pointBorderWidth: 1
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                point: {
                    radius: 3,
                    hitRadius: 6,
                    hoverRadius: 6
                }
            },
            layout: {
                padding: {
                    left: 10,
                    right: 10,
                    top: 10,
                    bottom: 10,
                },
            },
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 5,
                    title: {
                        display: true,
                        text: 'Spectral Period, T (s)',
                        color: '#241f25',
                        font: {
                            size: getResponsiveFontSize(1.8),
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        color: '#241f25',
                        font: { size: getResponsiveFontSize(1.6) },
                        callback: function(value) {
                            return value;
                        }
                    }
                },
                y: {
                    type: 'linear',
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Spectral Acceleration, Sa(T) (g)',
                        color: '#241f25',
                        font: {
                            size: getResponsiveFontSize(1.8),
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        color: '#241f25',
                        font: { size: getResponsiveFontSize(1.6) }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    align: 'start',
                    labels: {
                        boxWidth: 10,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: getResponsiveFontSize(1.5),
                            color: '#241f25'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function () {
                            return ''; // Don't show default title
                        },
                        label: function (context) {
                            const rp = context.dataset.label.replace("RP = ", "").replace("y", "");
                            const xValue = context.parsed.x.toFixed(2);
                            const yValue = context.parsed.y.toFixed(3);
                            return `RP = ${rp}y ‚Üí Sa(${xValue}s) = ${yValue}g`;
                        }
                    }
                }
            }
        }
    });
}


// Function to clear the chart when no valid data is found
function clearChart() {
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
}

// Attach event listeners to checkboxes to update chart dynamically
document.querySelectorAll('input[name="RP"]').forEach(cb => {
    cb.addEventListener('change', () => {
        setMarker(marker.getLatLng()); // Re-fetch UHS for current location
    });
});

// Initial Fetch for the default point
setMarker(marker.getLatLng());

// Download button functionality for UHS chart
document.getElementById("downloadButton").addEventListener("click", function () {
    const canvas = document.getElementById("uhs");
    const imageUrl = canvas.toDataURL("image/png");

    const percentile = document.getElementById("percentile").value;
    const mappedPercentile = percentileMapping[percentile] || percentile;

    const selectedRPs = Array.from(document.querySelectorAll('input[name="RP"]:checked'))
                            .map(cb => cb.value).join("_");

    const filename = `Aegis_UHS_${mappedPercentile}_${selectedRPs}.png`;

    const link = document.createElement("a");
    link.href = imageUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>

{% endblock %}


        